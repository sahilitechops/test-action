name: "ðŸ’» Local Test Deployment (Safe Mode)"

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "Enter a test folder name (e.g., test-site)"
        required: true
        default: "local-test-site"
      release_tag:
        description: "Enter the GitHub Release tag (e.g., release/V10.0.3)"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    # ðŸ‘‡ CHANGED: This matches the labels shown in your screenshot
    runs-on: [self-hosted, Windows]

    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Ensure GitHub CLI Installed"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "ðŸ“¦ GitHub CLI not found. Installing..."
            $version = "2.56.0"
            $zipUrl = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
            $zipPath = "$env:TEMP\ghcli.zip"
            $extractPath = "$env:ProgramData\ghcli"

            if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
            Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
            
            $ghExe = Get-ChildItem -Path $extractPath -Filter gh.exe -Recurse | Select-Object -First 1
            echo "$($ghExe.DirectoryName)" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Host "âœ… GitHub CLI is already installed."
          }

      - name: "ðŸ§¾ Download ZIPs"
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.event.inputs.release_tag }}"
          Write-Host "ðŸ“¥ Downloading assets for: $tag"
          
          # Create temp dir
          $downloadDir = "$PWD\release_zips"
          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null

          # Download
          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --dir $downloadDir

          $count = (Get-ChildItem -Path $downloadDir -Filter *.zip).Count
          if ($count -eq 0) { Write-Error "âŒ No ZIPs found for $tag"; exit 1 }
          
          echo "download_dir=$downloadDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: "ðŸ“¦ Extract ZIPs"
        id: extract
        shell: pwsh
        run: |
          $source = "${{ steps.download.outputs.download_dir }}"
          $extractRoot = "$PWD\deploy"
          if (Test-Path $extractRoot) { Remove-Item -Recurse -Force $extractRoot }
          New-Item -ItemType Directory -Path $extractRoot | Out-Null
          
          $zips = Get-ChildItem -Path $source -Filter *.zip
          foreach ($zip in $zips) {
            # Simplified extraction for local test
            $dest = Join-Path $extractRoot $zip.BaseName
            Expand-Archive -Path $zip.FullName -DestinationPath $dest -Force
          }
          
          echo "extract_root=$extractRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: "ðŸš€ Simulate Deployment (Safe File Copy)"
        shell: pwsh
        run: |
          $domain = "${{ github.event.inputs.domain }}"
          $root = "${{ steps.extract.outputs.extract_root }}"
          
          # ðŸ‘‡ CHANGED: Safe local path instead of D:\inetpub
          $baseTarget = "C:\Temp\DeployTest\$domain"

          Write-Host "==============================="
          Write-Host "ðŸš€ LOCAL TEST DEPLOYMENT"
          Write-Host "ðŸ“‚ Source: $root"
          Write-Host "ðŸŽ¯ Destination: $baseTarget"
          Write-Host "==============================="

          if (-Not (Test-Path $root)) { Write-Error "âŒ Source not found"; exit 1 }

          # Get all extracted folders
          $folders = Get-ChildItem -Path $root -Directory

          foreach ($folder in $folders) {
             $targetPath = Join-Path $baseTarget $folder.Name
             
             if (-not (Test-Path $targetPath)) {
                New-Item -ItemType Directory -Force -Path $targetPath | Out-Null
             }

             Write-Host "ðŸšš Copying $($folder.Name) -> $targetPath"
             Copy-Item "$($folder.FullName)\*" -Destination $targetPath -Recurse -Force
          }

          Write-Host "âœ… Success! Check your C:\Temp\DeployTest folder."

      - name: "ðŸ§¹ Cleanup"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD\release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD\deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "ðŸ§¹ Cleanup done."
