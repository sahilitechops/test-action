name: "üöÄ Local Frontend Deploy (Target: DESKTOP-IUAAE04)"

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Select your runner"
        required: true
        type: choice
        default: "DESKTOP-IUAAE04"
        options:
          - DESKTOP-IUAAE04
          - host24-frontend
          - host24-backend
      domain:
        description: "Enter test folder name (e.g., local-test)"
        required: true
        default: "local-test"
      release_tag:
        description: "Enter GitHub Release tag (e.g., release/V10.0.3)"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ${{ fromJson('{"DESKTOP-IUAAE04":["self-hosted","Windows"],"host24-frontend":["self-hosted","frontend"],"host24-backend":["self-hosted","backend"]}')[github.event.inputs.runner] }}

    steps:
      - name: "üì• Checkout Repository"
        uses: actions/checkout@v4

      - name: "‚öôÔ∏è Ensure GitHub CLI Installed"
        shell: powershell   # üëà FIXED: Uses standard Windows PowerShell
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "üì¶ GitHub CLI not found. Installing..."
            $version = "2.56.0"
            $zipUrl = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
            $zipPath = "$env:TEMP\ghcli.zip"
            $extractPath = "$env:ProgramData\ghcli"
            
            if (Test-Path $extractPath) { Remove-Item -Recurse -Force $extractPath }
            
            # Force TLS 1.2 for older Windows PowerShell
            [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
            Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
            
            Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
            $ghExe = Get-ChildItem -Path $extractPath -Filter gh.exe -Recurse | Select-Object -First 1
            echo "$($ghExe.DirectoryName)" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Host "‚úÖ GitHub CLI is already installed."
          }

      - name: "üßæ Download ZIPs"
        shell: powershell   # üëà FIXED
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag = "${{ github.event.inputs.release_tag }}"
          Write-Host "üì• Downloading assets for: $tag"
          $downloadDir = "$PWD\release_zips"
          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null
          
          # Using gh directly (assumes it's in path or installed above)
          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --dir $downloadDir
          
          $count = (Get-ChildItem -Path $downloadDir -Filter *.zip).Count
          if ($count -eq 0) { Write-Error "‚ùå No ZIPs found for $tag"; exit 1 }
          echo "download_dir=$downloadDir" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: "üì¶ Extract ZIPs"
        id: extract
        shell: powershell   # üëà FIXED
        run: |
          $source = "${{ steps.download.outputs.download_dir }}"
          $extractRoot = "$PWD\deploy"
          if (Test-Path $extractRoot) { Remove-Item -Recurse -Force $extractRoot }
          New-Item -ItemType Directory -Path $extractRoot | Out-Null
          
          $zips = Get-ChildItem -Path $source -Filter *.zip
          foreach ($zip in $zips) {
            $dest = Join-Path $extractRoot $zip.BaseName
            Expand-Archive -Path $zip.FullName -DestinationPath $dest -Force
          }
          echo "extract_root=$extractRoot" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: "üöÄ Local Deployment (Safe Mode)"
        shell: powershell   # üëà FIXED
        run: |
          $domain = "${{ github.event.inputs.domain }}"
          $root = "${{ steps.extract.outputs.extract_root }}"
          
          # Safe target for local test
          $baseTarget = "C:\Temp\DeployTest\$domain"

          Write-Host "==============================="
          Write-Host "üöÄ DEPLOYING TO: $baseTarget"
          Write-Host "==============================="

          if (-Not (Test-Path $root)) { Write-Error "‚ùå Source not found"; exit 1 }

          $folders = Get-ChildItem -Path $root -Directory
          foreach ($folder in $folders) {
             $targetPath = Join-Path $baseTarget $folder.Name
             if (-not (Test-Path $targetPath)) { New-Item -ItemType Directory -Force -Path $targetPath | Out-Null }
             
             Write-Host "üöö Copying $($folder.Name)..."
             Copy-Item "$($folder.FullName)\*" -Destination $targetPath -Recurse -Force
          }
          Write-Host "‚úÖ Success! Files are in C:\Temp\DeployTest\$domain"

      - name: "üßπ Cleanup"
        if: always()
        shell: powershell   # üëà FIXED
        run: |
          Remove-Item "$PWD\release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD\deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "üßπ Cleanup done."
