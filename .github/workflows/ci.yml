name: "ðŸšš Manual Backend Deploy (from Release ZIP)"

on:
  workflow_dispatch:
    inputs:
      host:
        description: "Select target host / runner"
        required: true
        type: choice
        options:
          - host24-backend
          - host24-frontend
          - host24-zip
          - AWS_Staging
          - AWS_PROD_01
          - AWS_PROD_02
          - AWS_PROD_03
          - AWS_PROD_04
          - AWS_PROD_05
          - ubuntu-latest
          - window-latest

      domain:
        description: "Comma-separated domain(s). Required."
        required: false

      exclude_domains:
        description: "Comma-separated domains to exclude manually"
        required: false

      restart_iis:
        description: "Restart IIS before & after Deployment?"
        required: false
        type: boolean

      app_type:
        description: "Deployment Type (backend -> AG, frontend -> httpdocs, both)"
        required: true
        type: choice
        options:
          - backend
          - frontend
          - both

      release_tag:
        description: "GitHub Release tag (e.g., release/V10.0.3)"
        required: true

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ${{ fromJson('{"host24-backend":["self-hosted","Windows","X64","host24","backend"],"host24-frontend":["self-hosted","Windows","X64","host24","frontend"],"host24-zip":["self-hosted","Windows","X64","host24","zip"],"AWS_Staging":["self-hosted","Windows","X64","AWS_Staging"],"AWS_PROD_01":["self-hosted","Windows","X64","AWS_PROD_01"],"AWS_PROD_02":["self-hosted","Windows","X64","AWS_PROD_02"],"AWS_PROD_03":["self-hosted","Windows","X64","AWS_PROD_03"],"AWS_PROD_04":["self-hosted","Windows","X64","AWS_PROD_04"],"AWS_PROD_05":["self-hosted","Windows","X64","AWS_PROD_05"]}')[github.event.inputs.host] }}
    steps:

      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4

      - name: "âš™ï¸ Ensure GitHub CLI Installed (ZIP fallback)"
        shell: pwsh
        run: |
          if (-not (Get-Command gh -ErrorAction SilentlyContinue)) {
            Write-Host "ðŸ“¦ Installing GitHub CLI (ZIP fallback)..."
            $version = "2.56.0"
            $url = "https://github.com/cli/cli/releases/download/v$version/gh_${version}_windows_amd64.zip"
            $zip = "$env:TEMP\ghcli.zip"
            $dest = "$env:ProgramData\ghcli"

            if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }

            Invoke-WebRequest -Uri $url -OutFile $zip
            Expand-Archive $zip $dest -Force

            $exe = Get-ChildItem $dest -Recurse -Filter gh.exe | Select-Object -First 1
            if (-not $exe) { Write-Error "âŒ gh.exe missing"; exit 1 }

            echo $exe.DirectoryName | Out-File $env:GITHUB_PATH -Append
            & "$($exe.FullName)" --version
          } else {
            Write-Host "âœ… GH CLI exists: $(gh --version | Select-String 'gh version')"
          }

      - name: "ðŸ§¾ Download ZIP Assets from GitHub Release"
        id: download
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $tag="${{ github.event.inputs.release_tag }}"
          Write-Host "ðŸ“¥ Downloading Release ZIPs for $tag..."
          gh release download $tag --repo "${{ github.repository }}" --pattern "*.zip" --clobber

          $downloadDir="$PWD/release_zips"
          if (Test-Path $downloadDir) { Remove-Item -Recurse -Force $downloadDir }
          New-Item -ItemType Directory -Path $downloadDir | Out-Null

          Move-Item *.zip $downloadDir -Force

          $count=(Get-ChildItem $downloadDir "*.zip").Count
          if ($count -eq 0) { Write-Error "âŒ No ZIP files found"; exit 1 }

          echo "download_dir=$downloadDir" >> $env:GITHUB_OUTPUT

      - name: "ðŸ“¦ Extract and Merge ZIPs"
        id: extract
        shell: pwsh
        run: |
          $src="${{ steps.download.outputs.download_dir }}"
          $root="$PWD/deploy"

          if (Test-Path $root) { Remove-Item -Recurse -Force $root }
          New-Item -ItemType Directory -Path $root | Out-Null

          $merged=Join-Path $root "merged"
          New-Item -ItemType Directory $merged | Out-Null

          foreach ($zip in Get-ChildItem $src "*.zip") {
            $tmp=Join-Path $root $zip.BaseName
            Expand-Archive $zip.FullName $tmp -Force

            Get-ChildItem $tmp | ForEach-Object {
              Copy-Item $_.FullName -Destination $merged -Recurse -Force
            }
          }

          echo "extract_root=$merged" >> $env:GITHUB_OUTPUT

      - name: "ðŸš€ Deploy to Domain(s)"
        id: deploy
        shell: pwsh
        run: |
          Import-Module WebAdministration

          $rawDomains="${{ github.event.inputs.domain }}"
          $rawExclude="${{ github.event.inputs.exclude_domains }}"
          $restart="${{ github.event.inputs.restart_iis }}"
          $type="${{ github.event.inputs.app_type }}"
          $source="${{ steps.extract.outputs.extract_root }}"

          $success=@()
          $failed=@()

          # --------------------------
          # CHECK INPUTS
          # --------------------------
          if ([string]::IsNullOrWhiteSpace($rawDomains)) {
            Write-Host "âŒ ERROR: No domain provided."
            exit 0
          }

          $domains=$rawDomains.Split(",") | ForEach-Object { $_.Trim() }

          if (-not [string]::IsNullOrWhiteSpace($rawExclude)) {
            $exclude=$rawExclude.Split(",") | ForEach-Object { $_.Trim() }
            Write-Host "ðŸš« Manual Exclude: $($exclude -join ', ')"
            $domains=$domains | Where-Object { $exclude -notcontains $_ }
          }

          if ($domains.Count -eq 0) {
            Write-Host "âš ï¸ No domains left after manual exclude!"
            exit 0
          }

          # --------------------------
          # DEPLOY LOOP
          # --------------------------
          foreach ($domain in $domains) {
            Write-Host "`n===================================="
            Write-Host "ðŸš€ Deploying to $domain"
            Write-Host "====================================`n"

            $pool=$domain
            $frontendPath="D:\inetpub\vhosts\$domain\httpdocs"
            $backendPath="D:\inetpub\vhosts\$domain\httpdocs\AG"

            # 1. Stop AppPool
            if ($restart -eq "true") {
              if (Test-Path "IIS:\AppPools\$pool") { Stop-WebAppPool $pool }
            }

            try {
              # 2. FRONTEND DEPLOYMENT (httpdocs)
              if ($type -eq "frontend" -or $type -eq "both") {
                Write-Host "ðŸ“‚ Deploying FRONTEND to: $frontendPath"

                if (-not (Test-Path $frontendPath)) {
                  New-Item -ItemType Directory -Path $frontendPath -Force | Out-Null
                }

                # OPTIONAL: Exclude 'AG' folder or dlls if source is mixed to keep root clean
                # Remove '-Exclude ...' if you want strictly everything copied
                Copy-Item "$source\*" $frontendPath -Recurse -Force -ErrorAction Stop -Exclude "AG"
              }

              # 3. BACKEND DEPLOYMENT (httpdocs\AG)
              if ($type -eq "backend" -or $type -eq "both") {
                Write-Host "ðŸ“‚ Deploying BACKEND to: $backendPath"

                if (-not (Test-Path $backendPath)) {
                  New-Item -ItemType Directory -Path $backendPath -Force | Out-Null
                }

                Copy-Item "$source\*" $backendPath -Recurse -Force -ErrorAction Stop
              }

              # 4. Start AppPool (Immediate recovery)
              if (Test-Path "IIS:\AppPools\$pool") { Start-WebAppPool $pool }
              $success+=$domain

            } catch {
              Write-Host "âŒ ERROR deploying to $domain"
              Write-Host "âš ï¸ $_"
              
              # Recover AppPool on failure
              if (Test-Path "IIS:\AppPools\$pool") { Start-WebAppPool $pool }
              $failed+=$domain
            }

            # 5. Ensure Start (redundant check for restart flag)
            if ($restart -eq "true") {
               if ((Get-WebAppPoolState $pool).Value -ne "Started") { Start-WebAppPool $pool }
            }
          }

          # --------------------------
          # GLOBAL IIS RESTART
          # --------------------------
          if ($restart -eq "true") {
            Write-Host "ðŸ”„ Restarting IIS globally..."
            iisreset /restart
          }

          # --------------------------
          # SUMMARY
          # --------------------------
          Write-Host "`n===================================="
          Write-Host "ðŸ“„ DEPLOYMENT SUMMARY"
          Write-Host "===================================="
          Write-Host "âœ… Successful: $(if($success){$success -join ','}else{'None'})"
          Write-Host "âŒ Failed: $(if($failed){$failed -join ','}else{'None'})"

          echo "success_domains=$($success -join ',')" >> $env:GITHUB_OUTPUT
          echo "failed_domains=$($failed -join ',')" >> $env:GITHUB_OUTPUT

      - name: "ðŸ§¹ Cleanup workspace"
        if: always()
        shell: pwsh
        run: |
          Remove-Item "$PWD/release_zips" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item "$PWD/deploy" -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "ðŸ§¹ Cleanup completed."
